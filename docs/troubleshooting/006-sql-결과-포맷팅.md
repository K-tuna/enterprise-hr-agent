# SQL 결과 포맷팅 오류

## 문제
- "김철수 휴가 몇 번?" → "2명" (횟수인데 "명"으로 출력)
- "김철수 지각 횟수" → "1명"
- 단위가 맥락에 맞지 않음

## 원인
- if문 기반 키워드 매칭으로 단위 결정
- `count_keywords = ["count", "직원수", "인원", "명", "employee"]` → 전부 "명"으로 처리
- 질문 맥락을 고려하지 않음

## 해결 과정

### 시도 1: 키워드 분기 추가
- 파일: `core/agents/sql_agent.py:267-289`
- 변경 전:
```python
def format_value(v, key=""):
    ...
    count_keywords = ["count", "직원수", "인원", "명", "employee"]
    is_count = any(kw in key_lower for kw in count_keywords)
    ...
    elif is_count and num == int(num):
        return f"{int(num)}명"
```
- 변경 후:
```python
# 직원 수 (명)
people_keywords = ["employee", "직원수", "인원"]
is_people = any(kw in key_lower for kw in people_keywords)

# 횟수 (회)
count_keywords = ["count", "횟수", "번"]
is_count = any(kw in key_lower for kw in count_keywords)
...
elif is_people and num == int(num):
    return f"{int(num)}명"
elif is_count and num == int(num):
    return f"{int(num)}회"
```
- 결과: 실패 (여전히 if문, 확장성 없음, 키워드로 모든 케이스 커버 불가)

### 시도 2: LLM 기반 답변 생성
- 파일: `core/agents/sql_agent.py:78-106`
- 변경 전:
```python
if success:
    answer = self._format_results(final["results"])
```
- 변경 후:
```python
if success:
    answer = self._generate_answer(question, final["results"])

def _generate_answer(self, question: str, results: List[Dict[str, Any]]) -> str:
    """LLM으로 자연어 답변 생성"""
    if not results:
        return "조회 결과가 없습니다."

    prompt = ChatPromptTemplate.from_messages([
        ("system", "SQL 조회 결과를 바탕으로 질문에 자연스러운 한국어로 답변하세요. 간결하게 핵심만 답하세요."),
        ("user", "질문: {question}\n\nSQL 결과: {results}\n\n답변:")
    ])

    chain = prompt | self.llm | StrOutputParser()
    return chain.invoke({"question": question, "results": str(results)})
```
- 결과: 성공

## 검증
- 테스트 입력: "김철수 휴가 몇 번?"
- 기대 결과: "김철수는 휴가를 1번 갔습니다." (또는 유사한 자연어)
- 실제 결과: "김철수는 총 2번 휴가를 갔습니다." ✅ (당시 ENUM 문제로 2번이었음, 003에서 해결)

- 테스트 입력: "김철수 지각 횟수"
- 기대 결과: 자연어로 횟수 표현
- 실제 결과: "김철수는 지각을 1회 했습니다." ✅

- 테스트 입력: "개발팀 평균 급여"
- 기대 결과: 자연어로 급여 표현
- 실제 결과: "개발팀의 평균 급여는 7,000,000원입니다." ✅
